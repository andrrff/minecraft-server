# Arquivo YAML para implantar um servidor Minecraft (modo offline) no Kubernetes
# Imagem Docker: itzg/minecraft-server

---
# 1. Namespace
# Cria um namespace dedicado para os recursos do servidor Minecraft.
apiVersion: v1
kind: Namespace
metadata:
  name: minecraft-server-ns # Nome do namespace
spec:
  finalizers:
    - kubernetes

---
# 2. StatefulSet
# Define o StatefulSet para gerenciar o pod do servidor Minecraft.
# StatefulSets s√£o ideais para aplica√ß√µes com estado, como servidores de jogos.
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: minecraft-server
  namespace: minecraft-server-ns # Implanta no namespace criado acima
  labels:
    app: minecraft-server
spec:
  serviceName: minecraft-service # Nome do Service que gerencia este StatefulSet
  replicas: 1 # Apenas uma r√©plica para um servidor Minecraft padr√£o
  selector:
    matchLabels:
      app: minecraft-server # Deve corresponder aos labels do template do pod
  template:
    metadata:
      labels:
        app: minecraft-server # Labels aplicados ao pod
    spec:
      nodeSelector:
        kubernetes.io/os: linux # Garante que o pod rode em n√≥s Linux
      containers:
        - name: minecraft-server-container
          image: itzg/minecraft-server:latest # Imagem Docker do servidor Minecraft
          imagePullPolicy: Always
          ports:
            - containerPort: 25565 # Porta padr√£o do Minecraft
              name: minecraft-tcp
            - containerPort: 25575 # Porta para RCON
              name: rcon-tcp

          env:
            # Configura√ß√µes Essenciais
            - name: EULA
              value: "TRUE"
            - name: ONLINE_MODE
              value: "false"
            - name: MEMORY
              value: ""
            - name: JVM_XX_OPTS
              value: "-XX:MaxRAMPercentage=75.0"
            - name: TYPE
              value: "FABRIC"
            - name: VERSION
              value: "1.21.5"
              
            # Configura√ß√µes de AFK e ociosidade
            - name: ENABLE_AUTOPAUSE
              value: "true"
            - name: AUTOPAUSE_TIMEOUT_EST
              value: "900" # 15 minutos antes de considerar um jogador como AFK
            - name: AUTOPAUSE_TIMEOUT_INIT
              value: "300" # 5 minutos antes de pausar o servidor ap√≥s o √∫ltimo jogador sair
            - name: AUTOPAUSE_PERIOD
              value: "10" # Intervalo em segundos para verificar jogadores AFK

            # Configura√ß√µes do Jogo (Exemplos)
            - name: SERVER_NAME
              value: "üî•Tales of Gozas Serverüî•"
            - name: MOTD
              value: "¬ß6¬ßl‚ú® Bem-vindo ao ¬ßc¬ßlüî•Tales of Gozas Serverüî•¬ßr ¬ß6¬ßl‚ú®\n¬ßa¬ßo‚ñ∫ Vers√£o 1.21.5 Fabric ¬ße[Modo Offline]"
            - name: WELCOME_MESSAGE
              value: "¬ß2Bem-vindo ao servidor, ¬ßb{PLAYER}¬ß2! Esperamos que voc√™ se divirta conosco.\n¬ß6Regras:\n¬ßf- Respeite os outros jogadores\n¬ßf- N√£o griefing\n¬ßf- Divirta-se!"
            - name: DIFFICULTY
              value: "normal" # easy, normal, hard, peaceful
            - name: MAX_PLAYERS
              value: "15"
            - name: SPAWN_PROTECTION
              value: "0"
            - name: ALLOW_NETHER
              value: "true"
            - name: ANNOUNCE_PLAYER_ACHIEVEMENTS
              value: "true"
            - name: ENABLE_COMMAND_BLOCK
              value: "false"
            - name: FORCE_GAMEMODE
              value: "false"
            - name: GENERATE_STRUCTURES
              value: "true"
            - name: PVP
              value: "true"
            - name: VIEW_DISTANCE
              value: "18"
            - name: SEED
              value: "7328636133801045505" # Seed do mundo personalizada

            # Configura√ß√µes do RCON (habilitado)
            - name: ENABLE_RCON
              value: "true"
            - name: RCON_PORT
              value: "25575"
            - name: RCON_PASSWORD
              value: "minecraft_secure_password" # Recomendado: use uma senha mais segura

          volumeMounts:
            - name: minecraft-data # Monta o volume persistente
              mountPath: /data # Diret√≥rio onde os dados do servidor s√£o armazenados na imagem
          resources: # Requisi√ß√µes e limites de recursos (ajuste conforme necess√°rio)
            requests:
              memory: "1Gi" # M√≠nimo de mem√≥ria requisitada
              cpu: "500m"   # M√≠nimo de CPU requisitada (0.5 core)
            limits:
              memory: "7Gi" # M√°ximo de mem√≥ria permitida
              cpu: "2000m"  # M√°ximo de CPU permitida (2 cores)
          livenessProbe: # Verifica se o container est√° vivo
            tcpSocket:
              port: 25565
            # initialDelaySeconds: 60 # Espera 60s antes da primeira verifica√ß√£o
            periodSeconds: 30       # Verifica a cada 30s
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe: # Verifica se o container est√° pronto para receber tr√°fego
            tcpSocket:
              port: 25565
            # initialDelaySeconds: 90 # Espera 90s (tempo para o servidor iniciar)
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

  volumeClaimTemplates: # Define o template para o PersistentVolumeClaim
    - metadata:
        name: minecraft-data # Nome do PVC
        namespace: minecraft-server-ns
      spec:
        accessModes: [ "ReadWriteOnce" ] # Permite leitura e escrita por um √∫nico n√≥
        resources:
          requests:
            storage: 10Gi # Tamanho do armazenamento (ajuste conforme necess√°rio)
        # storageClassName: "your-storage-class" # Descomente e ajuste se voc√™ tiver uma StorageClass espec√≠fica

---
# 3. Service
# Exp√µe o servidor Minecraft para acesso externo.
apiVersion: v1
kind: Service
metadata:
  name: minecraft-service
  namespace: minecraft-server-ns # No mesmo namespace
  labels:
    app: minecraft-server
spec:
  type: LoadBalancer # Exp√µe usando um LoadBalancer (requer suporte do provedor de nuvem)
  # Se LoadBalancer n√£o estiver dispon√≠vel (ex: Minikube local), use NodePort:
  # type: NodePort
  ports:
    - port: 25565 # Porta externa
      targetPort: minecraft-tcp # Porta do container (nomeada no StatefulSet)
      protocol: TCP
      name: minecraft-tcp
    - port: 25575 # Porta externa para RCON
      targetPort: rcon-tcp # Porta do container para RCON
      protocol: TCP
      name: rcon-tcp
  selector:
    app: minecraft-server # Seleciona os pods com este label (os do StatefulSet)

---
# 4. PersistentVolumeClaim para armazenar os backups
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: minecraft-backup-storage
  namespace: minecraft-server-ns
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 30Gi  # Tamanho adequado para armazenar um m√™s de backups

---
# 5. ConfigMap com script de backup
apiVersion: v1
kind: ConfigMap
metadata:
  name: minecraft-backup-script
  namespace: minecraft-server-ns
data:
  backup.sh: |
    #!/bin/bash
    set -e  # Encerra o script se qualquer comando falhar
    
    # Configura vari√°veis
    BACKUP_DIR="/backups"
    SOURCE_DIR="/minecraft-data"
    RETENTION_DAYS=30
    TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
    BACKUP_FILE="$BACKUP_DIR/minecraft-backup-$TIMESTAMP.tar.gz"
    
    # Envia mensagens ao servidor via RCON (se dispon√≠vel)
    if [ -x "$(command -v rcon-cli)" ]; then
      echo "Notificando jogadores sobre o backup..."
      rcon-cli --host localhost --port 25575 --password $RCON_PASSWORD "say ¬ße[SISTEMA] ¬ß6Iniciando backup do servidor... Pode haver alguma lentid√£o."
      rcon-cli --host localhost --port 25575 --password $RCON_PASSWORD "save-all"
      rcon-cli --host localhost --port 25575 --password $RCON_PASSWORD "save-off"
      sleep 5
    else
      echo "RCON n√£o dispon√≠vel. Continuando sem notificar jogadores."
    fi
    
    # Diret√≥rios e arquivos para excluir do backup
    echo "Iniciando backup em $(date)"
    echo "Compactando arquivos do servidor..."
    
    # Criar backup com exclus√µes para arquivos problem√°ticos
    tar -czf "$BACKUP_FILE" \
      --exclude="./logs/*.log.gz" \
      --exclude="./crash-reports" \
      --exclude="./debug" \
      --warning=no-file-changed \
      -C "$SOURCE_DIR" .
    
    BACKUP_STATUS=$?
    
    # Reativa o salvamento (se RCON dispon√≠vel)
    if [ -x "$(command -v rcon-cli)" ]; then
      rcon-cli --host localhost --port 25575 --password $RCON_PASSWORD "save-on"
      rcon-cli --host localhost --port 25575 --password $RCON_PASSWORD "say ¬ße[SISTEMA] ¬ßaBackup conclu√≠do."
    fi
    
    # Verifica se o backup foi bem-sucedido (aceita c√≥digo 0 ou 1)
    if [ $BACKUP_STATUS -eq 0 ] || [ $BACKUP_STATUS -eq 1 ]; then
      echo "Backup conclu√≠do com sucesso: $BACKUP_FILE"
      echo "Tamanho do backup: $(du -h $BACKUP_FILE | cut -f1)"
    else
      echo "Falha ao criar backup! C√≥digo de erro: $BACKUP_STATUS"
      exit 1
    fi
    
    # Remove backups mais antigos que o per√≠odo de reten√ß√£o
    echo "Verificando e removendo backups antigos (mais de $RETENTION_DAYS dias)..."
    find "$BACKUP_DIR" -name "minecraft-backup-*.tar.gz" -type f -mtime +$RETENTION_DAYS -delete
    
    # Relat√≥rio final de uso de espa√ßo
    echo "Espa√ßo total usado por backups: $(du -sh $BACKUP_DIR | cut -f1)"
    echo "Processo de backup finalizado em $(date)."

---
# 6. CronJob para executar o backup automaticamente
apiVersion: batch/v1
kind: CronJob
metadata:
  name: minecraft-backup
  namespace: minecraft-server-ns
spec:
  schedule: "0 */12 * * *"  # A cada 12 horas (√†s 00:00 e 12:00)
  concurrencyPolicy: Forbid  # N√£o permite execu√ß√µes sobrepostas
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backup-container
            image: bitnami/minideb:latest  # Imagem leve com ferramentas b√°sicas
            command:
            - /bin/bash
            - /scripts/backup.sh
            volumeMounts:
            - name: minecraft-data-source
              mountPath: /minecraft-data
              readOnly: true  # Acesso somente leitura aos dados do servidor
            - name: backup-storage
              mountPath: /backups
            - name: backup-script
              mountPath: /scripts
          restartPolicy: OnFailure
          volumes:
          - name: minecraft-data-source
            persistentVolumeClaim:
              claimName: minecraft-data-minecraft-server-0  # Refer√™ncia ao PVC criado pelo StatefulSet
          - name: backup-storage
            persistentVolumeClaim:
              claimName: minecraft-backup-storage
          - name: backup-script
            configMap:
              name: minecraft-backup-script
              defaultMode: 0755  # Torna o script execut√°vel

